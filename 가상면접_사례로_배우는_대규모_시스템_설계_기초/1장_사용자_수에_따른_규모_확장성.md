# 사용자 수에 따른 규모 확장성

keyword: 서버증설, 로드밸런서, 데이터베이스 다중화
추가로 공부해보면 좋을: 다중 마스터, 원형 다중화

## 수직적 규모 확장 vs 수평적 규모 확장

### 수직적 규모 확장

- 스케일 업 (Sacle up)
- 서버에 고사양 자원을 추가하는 행위


### 수평적 규모 확장

- 더 많은 서버를 추가하여 성능을 개선하는 행위

### 뭐가 더 좋은 선택일까?

트래픽의 양이 적은 편인것이 변하지 않는 사실이라면 수직적 규모 확장이 좋은 선택일 수 있다.

하지만, 수직적 규모 확장에는 한계가 있다.
- 한 대의 서버에 CPU나 메모리를 무한대로 증설할 수는 없다.
- 장애에 대한 자동 복구(failover) 방안이나 다중화(re-dundancy) 방안을 제시하지 않는다. 서버에 장애가 발생하면 웹사이트/앱은 완전히 중단된다.

그래서 대부분은 **수평적 규모 확장**이 적절하다.

## 로드밸런서

수평적 규모 확장을 기본으로 한 로르밸런서를 알아보자.

- 부하 분산 집합 (load balancing set)에 속한 웹 서버 들에게 트래픽 **부하를 고르게 분산**하는 역할
- 외부에서 접근은 공개 IP 주소(public IP Address)
- 로드밸런서는 내부적으로 사설 IP 주소(private IP Address)를 이용
- 장애 자동 복구 문제 해결, 웹 계층의 가용성 향상
	- 서버 하나가 다운되면 살아있는 서버들에 분산 -> 서버 전체가 다운되는 일 방지
	- 트래픽의 가파른 증가 -> 서버 증설로 트래픽 분산

웹 계층의 트래픽 해결.


## 데이터베이스 다중화

위키피디아
> "많은 데이터베이스 관리 시스템이 다중화를 지원한다. 보통 서버 사이에 master-slave 관계를 설정하고 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식이다."

- 쓰기 연산은 master에만 지원
- slave는 master로 부터 사본을 전달받고 읽기 연산만 지원
- 대부분의 어플리케이션은 읽기 연산의 비중이 훨씬 높다.
- 통상적으로는 slave 수가 많다.

### 데이터베이스 다중화의 장점

- 더 나은 성능
	- 읽기와 쓰기 트래픽 분산. 병렬로 처리가 가능해지기 때문에 성능이 좋아짐
- 안전성 (reliability)
	- 물리적으로 파괴 되어도 데이터 보존. 지역적으로 떨어진 여러 장소에 다중화하기 때문.
- 가용성 (availability)
	- 데이터를 여려지역에 복제. 장애가 발생하면 다른 서버에서 가져와 서비스 할 수 있음.

주 데이터베이스가 다운되면? -> 살아있는 slave 데이터베이스가 주 데이터베이스로 대체
실무에서는 더 복잡한 상황인 경우가 많다. 부 데이터베이스의 상태가 최신이 아닐 수 있다.
-> 복구 스크립트(recovery script)를 실행하여 추가한다.
-> 다중마스터 or 원형 다중화 방식을 도입하면 도움이 될 수 있다. 따로 공부해보면 좋을 부분


## 캐시

연산비용이 큰 데이터를 메모리에 두고 요청이 보다 빨리 처리될 수 있도록 하는 저장소

애플리케이션의 성능으 데이터베이스를 얼마나 자주 호출하느냐에 크게 좌우한다.
캐시는 그런 문제를 완화히줌

### 캐시 계층

읽기 주도형 캐시 전략(read-through caching strateagy)

- 캐시를 확인하고 없으면 데이터베이스에서 찾아와 캐시에 저장하고 반환


### 캐시 사용 주의사항

- 어떤상황?
	- 갱신보다 참조가 많은 상황에 적합
- 어떤 데이터?
	- 데이터를 휘발성 메모리에 둔다. 영구적 보관 데이터는 바람직하지 않음.
- 데이터 만료?
	- 만료 정책이 없으면 데이터가 메모리에 계속 남아있다.
	- 너무 짧으면 성능상 이점이 작아질 것이고 길어지면 원본과 차이가 날 가능성이 있다.
- 일관성 유지?
	- 일관성: 원본과 캐시 데이터가 동일한지
	- 관련 논문 [`<Scaling Memcache at Facebook>`](https://nymets.medium.com/%EB%B2%88%EC%97%AD-scaling-memcache-at-facebook-9c67f9e61282)
- 장애 대처?
	- 캐시 서버가 한대 -> 단일 장애 지점(Single Point of Failure, SPOF)이 되어버릴 가능성이 높음
	- 단일 장애 지점(Single Point of Failure, SPOF): 어떤 특정 지점에서의 장애가 전체 시스템의 동작을 중단시켜버리는 경우
	- 여러 지역에 걸쳐 캐시서버를 분산해야한다.
- 캐시 메모리 크기?
	- 메모리가 너무 작으면, 너무 자주 캐시에 밀려나버려 캐시의 성능이 떨어진다.
	- 해결 : 캐시 메모리를 과할당(overprovision) 한다.
- 캐시 방출 정책은 무엇인가?
	- 캐시가 꽉찼을 때 추가로 캐시에 데이터를 넣어야 할 경우 기존 데이터를 내보내야 한다.
	- 널리쓰이는 방식 LRU
	- 다른정책 LFU, FIFO..